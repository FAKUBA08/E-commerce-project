<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="index.css">
    <title>Home - Exclusive E-Commerce Website</title>
  </head>
  <body>
    <div class="top_nav">
        <div class="container top_nav_container">
          <div class="top_nav_wrapper">
            <p class="tap_nav_p">
              Summer Sale For All Swim Suits And Free Express Delivery - OFF 50%!
            </p>
            <a href="#" class="top_nav_link">SHOP NOW</a>
          </div>
        </div>
      </div>
      <nav class="nav">
        <div class="container nav_container">
          <a href="#" class="nav_logo">EXCLUSIVE</a>
          <ul class="nav_list">
            <li class="nav_item"><a href="/" class="nav_link">Home</a></li>
            <li class="nav_item"><a href="#" class="nav_link">About</a></li>
            <li class="nav_item"><a href="#" class="nav_link">Contact</a></li>
            <li class="nav_item">
              <a href="SIGNUP PAGE/index.html" class="nav_link">Sign up</a>
            </li>
          </ul>
          <div class="nav_items">
            <form action="#" class="nav_form">
              <input
                type="text"
                class="nav_input"
                placeholder="search here...." />
              <img src="../image/search.png" alt="" class="nav_search" />
            </form>
            <img src="../image/heart.png" alt="" class="nav_heart" />
            <a href="cart/index.html">
              <img src="../image/cart.png" alt="" class="nav_cart" />
              <span id="cartItemCount" class="cart_item_count">0</span>
            </a>
          </div>
          <p class="greetingP">HELLO,GUEST</p>
          <span class="hamburger">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-6 h-6">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
          </span>
        </div>
      </nav>
      <nav class="mobile_nav mobile_nav_hide">
        <ul class="mobile_nav_list">
          <li class="mobile_nav_item">
            <a href="/" class="mobile_nav_link">Home</a>
          </li>
          <li class="mobile_nav_item">
            <a href="#" class="mobile_nav_link">About</a>
          </li>
          <li class="mobile_nav_item">
            <a href="#" class="mobile_nav_link">Contact</a>
          </li>
          <li class="mobile_nav_item">
            <a href="./SIGNUP PAGE/index.html" class="mobile_nav_link">Sign Up</a>
          </li>
          <li class="mobile_nav_item">
            <a href="cart/index.html" class="mobile_nav_link">Cart</a>
            <span id="cartItemCount" class="cart_item_count"></span>
          </li>
          <p class="greetingP"></p>
        </ul>
      </nav>
</div>
<div id="spinner" class="spinner" style="display: none;">
  <div class="loading">Loading...</div>
</div>
<div class="return">
    <p class="home">Home <span class="cart">/ Cart</span></p>
</div>
<div class="list">
    <div class="pro">Product</div>
    <div class="price">Price</div>
    <div class="quantity">Quantity</div>
    <div class="subtotal">Subtotal</div>
    <!-- <div class="actions">Actions</div> -->
</div>
<div class="card">
    <div id="cartDetails" class="p-4"></div> 
</div>



    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script src="./js/app.js"></script>
    
  </body>
   <!-- Firebase SDKs -->
   <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc,deleteDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPF--p3fzATWasmeh_Lhq8XIDfX7WII_o",
        authDomain: "details-9e162.firebaseapp.com",
        projectId: "details-9e162",
        storageBucket: "details-9e162.appspot.com",
        messagingSenderId: "91758916888",
        appId: "1:91758916888:web:f72964b229d3af1b1ada6d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const greetingP = document.querySelector('.greetingP');

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docRef = doc(db, 'users', user.uid);
            const docSnapshot = await getDoc(docRef);
            const userData = docSnapshot.data();
            if (userData) {
                greetingP.textContent = `HELLO, ${userData.name}`;
            }
            loadCartItems(user.uid); // Load cart items for authenticated user
        } else {
            greetingP.textContent = 'HELLO, GUEST';
        }
    });

    
    function seen(data) {
    data.splice(0, 7).forEach(element => {
        document.getElementById('show').innerHTML += `
            <div class="max-w-sm w-full bg-white shadow-md rounded-lg dark:bg-gray-800 dark:border-gray-700 product-card">
                <a href="#">
                    <img class="rounded-t-lg" src="${element.image}" alt="product image">
                </a>
                <div class="px-5 pb-5">
                    <a href="#">
                        <h3>${element.title}</h3>
                    </a>
                    <div class="rating mt-2.5 mb-5">
                        <!-- Rating SVGs -->
                    </div>
                    <div class="flex items-center">
                        <span class="price text-gray-900 dark:text-white">$${element.price}</span>
                        <button class="text-white bg-red-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 add-to-cart" data-product-id="${element.id}" data-title="${element.title}" data-price="${element.price}" data-image="${element.image}">Add to cart</button>
                    </div>
                </div>
            </div>
        `;
    });

    document.querySelectorAll('button[data-title]').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const title = this.getAttribute('data-title');
            const price = this.getAttribute('data-price');
            const image = this.getAttribute('data-image');
            addToCart(productId, title, price, image);
        });
    });
}

   
async function addToCart(productId, title, price, image) {
    const user = auth.currentUser;
    if (user) {
        const uid = user.uid;
        const productRef = collection(db, "users", uid, "cartItems");
        const q = query(productRef, where("id", "==", productId));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            // Product exists, update its quantity and subtotal
            const existingProductDoc = querySnapshot.docs[0];
            const existingProduct = existingProductDoc.data();
            existingProduct.quantity = (existingProduct.quantity || 1) + 1;
            existingProduct.subtotal = parseFloat(existingProduct.price) * existingProduct.quantity;

            await updateDoc(existingProductDoc.ref, existingProduct);
            showPopup('Product quantity updated successfully!');
        } else {
            // New product, add to cart
            const product = { id: productId, title, price: parseFloat(price), image, quantity: 1, subtotal: parseFloat(price) };
            await addDoc(productRef, product);
            showPopup('Product added to cart successfully!');
        }

        updateCartDetails();
    } else {
        window.location.href = "./SIGNUP PAGE/index.html";
    }
}

async function loadCartItems(uid) {
    const cartDetailsElement = document.getElementById('cartDetails');
    let cartHTML = '';

    const q = query(collection(db, "users", uid, "cartItems"));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
        cartHTML += '<p>No items in cart</p>';
    } else {
        querySnapshot.forEach((doc) => {
            const product = doc.data();
            let price = product.price;
            if (typeof price === 'string' && price.trim().startsWith('$')) {
                price = parseFloat(price.replace('$', '')).toFixed(2); 
            } else {
                price = parseFloat(price).toFixed(2); 
            }

            const quantity = product.quantity || 1;
            const subtotal = (price * quantity).toFixed(2);

            if (!isNaN(price)) {
                cartHTML += `
                    <div class="list_item" data-id="${doc.id}">
                        <div class="pro">
                            <img src="${product.image}" alt="${product.title}" class="w-16 h-16">
                            <span>${product.title}</span>
                        </div>
                        <div class="price">$${price}</div>
                        <div class="quantity">
                            <input type="number" value="${quantity}" min="1" class="quantity_input">
                        </div>
                        <div class="subtotal">$${subtotal}</div>
                        <button class="delete-item text-red-700"><img src="../image/1840748.png" alt=""></button>
                    </div>
                `;
            } else {
                console.error('Invalid price for product:', product);
            }
        });
    }

    cartDetailsElement.innerHTML = cartHTML;

    document.querySelectorAll('.delete-item').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.parentElement.getAttribute('data-id');
            deleteCartItem(uid, productId);
        });
    });
}

async function updateCartDetails() {
    const user = auth.currentUser;
    if (user) {
        const uid = user.uid;
        const q = query(collection(db, "users", uid, "cartItems"));
        const querySnapshot = await getDocs(q);
        const cartItemCount = querySnapshot.size; // Get the number of items in the cart
        document.getElementById('cartItemCount').textContent = cartItemCount.toString(); // Update the cart item count
    } else {
        console.error("No user is signed in");
    }
}

async function deleteCartItem(uid, productId) {
    const spinner = document.getElementById('spinner');
    
    try {
        // Show the spinner
        spinner.style.display = 'block';
        
        await deleteDoc(doc(db, "users", uid, "cartItems", productId));
        console.log("Document successfully deleted!");

        loadCartItems(uid); // Reload cart items to update the UI
        updateCartDetails(); 

    } catch (error) {
        console.error("Error removing document: ", error);
    } finally {
        // Hide the spinner
        spinner.style.display = 'none';
    }
}
document.addEventListener('DOMContentLoaded', () => {
    document.addEventListener('input', (event) => {
        if (event.target.classList.contains('quantity_input')) {
            const quantity = event.target.value;
            const priceElement = event.target.closest('.list_item').querySelector('.price');
            const subtotalElement = event.target.closest('.list_item').querySelector('.subtotal');
            const price = parseFloat(priceElement.textContent.replace('$', ''));
            const subtotal = price * quantity;
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;

            // Update Firestore with new quantity and subtotal
            const listItemElement = event.target.closest('.list_item');
            const productId = listItemElement.getAttribute('data-id');
            const user = auth.currentUser;
            if (user) {
                const uid = user.uid;
                const productRef = doc(db, "users", uid, "cartItems", productId);
                updateDoc(productRef, {
                    quantity: parseInt(quantity),
                    subtotal: subtotal
                }).then(() => {
                    console.log('Cart item updated successfully');
                }).catch((error) => {
                    console.error('Error updating cart item: ', error);
                });
            }
        }
    });
});



</script>
<script src="../js/app.js"></script>
